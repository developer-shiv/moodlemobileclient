{"version":3,"sources":["./src/core/features/settings/pages/space-usage/space-usage.html","./src/core/features/settings/pages/space-usage/space-usage.module.ts","./src/core/features/settings/pages/space-usage/space-usage.ts"],"names":[],"mappings":"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","file":"pages-space-usage-space-usage-module.js","sourcesContent":["export default \"<ion-header>\\r\\n    <ion-toolbar>\\r\\n        <ion-buttons slot=\\\"start\\\">\\r\\n            <ion-back-button [text]=\\\"'core.back' | translate\\\"></ion-back-button>\\r\\n        </ion-buttons>\\r\\n        <h1>{{ 'core.settings.spaceusage' | translate }}</h1>\\r\\n        <ion-buttons slot=\\\"end\\\">\\r\\n            <core-navbar-buttons>\\r\\n                <ion-button (click)=\\\"showInfo()\\\" [attr.aria-label]=\\\"'core.info' | translate\\\">\\r\\n                    <ion-icon name=\\\"fas-info-circle\\\" slot=\\\"icon-only\\\" aria-hidden=\\\"true\\\"></ion-icon>\\r\\n                </ion-button>\\r\\n            </core-navbar-buttons>\\r\\n        </ion-buttons>\\r\\n    </ion-toolbar>\\r\\n</ion-header>\\r\\n<ion-content>\\r\\n    <ion-refresher [disabled]=\\\"!loaded\\\" (ionRefresh)=\\\"refreshData($event.target)\\\" slot=\\\"fixed\\\">\\r\\n        <ion-refresher-content pullingText=\\\"{{ 'core.pulltorefresh' | translate }}\\\"></ion-refresher-content>\\r\\n    </ion-refresher>\\r\\n    <core-loading [hideUntil]=\\\"loaded\\\">\\r\\n        <ion-item *ngFor=\\\"let site of sites\\\" [attr.aria-current]=\\\"site.id == currentSiteId ? 'page' : 'false'\\\">\\r\\n            <ion-label class=\\\"ion-text-wrap\\\">\\r\\n                <p class=\\\"item-heading\\\">\\r\\n                    <core-format-text [text]=\\\"site.siteName\\\" clean=\\\"true\\\" [siteId]=\\\"site.id\\\"></core-format-text>\\r\\n                </p>\\r\\n                <p class=\\\"ion-text-wrap\\\">{{ site.fullName }}</p>\\r\\n                <p>{{ site.siteUrl }}</p>\\r\\n            </ion-label>\\r\\n            <p *ngIf=\\\"site.spaceUsage !== undefined\\\" slot=\\\"end\\\">\\r\\n                {{ site.spaceUsage | coreBytesToSize }}\\r\\n            </p>\\r\\n            <ion-button fill=\\\"clear\\\" color=\\\"danger\\\" slot=\\\"end\\\" (click)=\\\"deleteSiteStorage(site)\\\"\\r\\n                [hidden]=\\\"site.spaceUsage! + site.cacheEntries! <= 0\\\"\\r\\n                [attr.aria-label]=\\\"'core.settings.deletesitefilestitle' | translate\\\">\\r\\n                <ion-icon name=\\\"fas-trash\\\" slot=\\\"icon-only\\\" aria-hidden=\\\"true\\\"></ion-icon>\\r\\n            </ion-button>\\r\\n        </ion-item>\\r\\n        <ion-item-divider>\\r\\n            <ion-label>\\r\\n                <h2>{{ 'core.settings.total' | translate }}</h2>\\r\\n            </ion-label>\\r\\n            <p slot=\\\"end\\\" class=\\\"ion-margin-end\\\">\\r\\n                {{ totals.spaceUsage | coreBytesToSize }}\\r\\n            </p>\\r\\n        </ion-item-divider>\\r\\n    </core-loading>\\r\\n</ion-content>\\r\\n\";","// (C) Copyright 2015 Moodle Pty Ltd.\r\n//\r\n// Licensed under the Apache License, Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//     http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n\r\nimport { NgModule } from '@angular/core';\r\nimport { RouterModule, Routes } from '@angular/router';\r\n\r\nimport { CoreSharedModule } from '@/core/shared.module';\r\nimport { CoreSettingsSpaceUsagePage } from './space-usage';\r\n\r\nconst routes: Routes = [\r\n    {\r\n        path: '',\r\n        component: CoreSettingsSpaceUsagePage,\r\n    },\r\n];\r\n\r\n@NgModule({\r\n    imports: [\r\n        RouterModule.forChild(routes),\r\n        CoreSharedModule,\r\n    ],\r\n    declarations: [\r\n        CoreSettingsSpaceUsagePage,\r\n    ],\r\n    exports: [RouterModule],\r\n})\r\nexport class CoreSettingsSpaceUsagePageModule {}\r\n","// (C) Copyright 2015 Moodle Pty Ltd.\r\n//\r\n// Licensed under the Apache License, Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//     http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n\r\nimport { Component, OnDestroy, OnInit } from '@angular/core';\r\nimport { IonRefresher } from '@ionic/angular';\r\n\r\nimport { CoreSiteBasicInfo, CoreSites } from '@services/sites';\r\nimport { CoreDomUtils } from '@services/utils/dom';\r\nimport { Translate } from '@singletons';\r\nimport { CoreEventObserver, CoreEvents } from '@singletons/events';\r\n\r\nimport { CoreSettingsHelper, CoreSiteSpaceUsage } from '../../services/settings-helper';\r\n\r\n/**\r\n * Page that displays the space usage settings.\r\n */\r\n@Component({\r\n    selector: 'page-core-app-settings-space-usage',\r\n    templateUrl: 'space-usage.html',\r\n})\r\nexport class CoreSettingsSpaceUsagePage implements OnInit, OnDestroy {\r\n\r\n    loaded = false;\r\n    sites: CoreSiteBasicInfoWithUsage[] = [];\r\n    currentSiteId = '';\r\n    totals: CoreSiteSpaceUsage = {\r\n        cacheEntries: 0,\r\n        spaceUsage: 0,\r\n    };\r\n\r\n    protected sitesObserver: CoreEventObserver;\r\n\r\n    constructor() {\r\n        this.currentSiteId = CoreSites.getCurrentSiteId();\r\n\r\n        this.sitesObserver = CoreEvents.on(CoreEvents.SITE_UPDATED, async (data) => {\r\n            const site = await CoreSites.getSite(data.siteId);\r\n\r\n            const siteEntry = this.sites.find((siteEntry) => siteEntry.id == site.id);\r\n            if (siteEntry) {\r\n                const siteInfo = site.getInfo();\r\n\r\n                siteEntry.siteName = site.getSiteName();\r\n\r\n                if (siteInfo) {\r\n                    siteEntry.siteUrl = siteInfo.siteurl;\r\n                    siteEntry.fullName = siteInfo.fullname;\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * View loaded.\r\n     */\r\n    ngOnInit(): void {\r\n        this.loadSiteData().finally(() => {\r\n            this.loaded = true;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Convenience function to load site data/usage and calculate the totals.\r\n     *\r\n     * @return Resolved when done.\r\n     */\r\n    protected async loadSiteData(): Promise<void> {\r\n        // Calculate total usage.\r\n        let totalSize = 0;\r\n        let totalEntries = 0;\r\n\r\n        this.sites = await CoreSites.getSortedSites();\r\n\r\n        const settingsHelper = CoreSettingsHelper.instance;\r\n\r\n        // Get space usage.\r\n        await Promise.all(this.sites.map(async (site) => {\r\n            const siteInfo = await settingsHelper.getSiteSpaceUsage(site.id);\r\n\r\n            site.cacheEntries = siteInfo.cacheEntries;\r\n            site.spaceUsage = siteInfo.spaceUsage;\r\n\r\n            totalSize += site.spaceUsage || 0;\r\n            totalEntries += site.cacheEntries || 0;\r\n        }));\r\n\r\n        this.totals.spaceUsage = totalSize;\r\n        this.totals.cacheEntries = totalEntries;\r\n    }\r\n\r\n    /**\r\n     * Refresh the data.\r\n     *\r\n     * @param event Refresher event.\r\n     */\r\n    refreshData(refresher?: IonRefresher): void {\r\n        this.loadSiteData().finally(() => {\r\n            refresher?.complete();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Deletes files of a site and the tables that can be cleared.\r\n     *\r\n     * @param siteData Site object with space usage.\r\n     */\r\n    async deleteSiteStorage(siteData: CoreSiteBasicInfoWithUsage): Promise<void> {\r\n        try {\r\n            const newInfo = await CoreSettingsHelper.deleteSiteStorage(siteData.siteName || '', siteData.id);\r\n\r\n            this.totals.spaceUsage -= siteData.spaceUsage! - newInfo.spaceUsage;\r\n            this.totals.spaceUsage -= siteData.cacheEntries! - newInfo.cacheEntries;\r\n\r\n            siteData.spaceUsage = newInfo.spaceUsage;\r\n            siteData.cacheEntries = newInfo.cacheEntries;\r\n        } catch {\r\n            // Ignore cancelled confirmation modal.\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Show information about space usage actions.\r\n     */\r\n    showInfo(): void {\r\n        CoreDomUtils.showAlert(\r\n            Translate.instant('core.help'),\r\n            Translate.instant('core.settings.spaceusagehelp'),\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Page destroyed.\r\n     */\r\n    ngOnDestroy(): void {\r\n        this.sitesObserver?.off();\r\n    }\r\n\r\n}\r\n\r\n/**\r\n * Basic site info with space usage and cache entries that can be erased.\r\n */\r\nexport interface CoreSiteBasicInfoWithUsage extends CoreSiteBasicInfo {\r\n    cacheEntries?: number; // Number of cached entries that can be cleared.\r\n    spaceUsage?: number; // Space used in this site.\r\n}\r\n"],"sourceRoot":"webpack:///"}